{% extends "base.html" %}
{% block head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <style>
    /* New modern styles */
    .result-header {
      text-align: left;
      margin-bottom: 2.5rem;
      padding: 2rem;
      background: var(--glass-bg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-md);
    }
    
    .result-header h1 { 
      font-size: 2.25rem; 
      font-weight: 800;
      color: var(--accent-color);
    }
    
    .result-header .sub-details {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem 2rem;
      color: var(--secondary-text-color);
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }
    
    .result-header .sub-details span { 
      font-weight: 600; 
      color: var(--primary-text-color);
    }

    .section-card {
      background: var(--card-bg-color);
      padding: 2rem;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
      margin-bottom: 2rem;
      transition: transform 0.2s ease;
    }

    .map-full { 
      width: 100%; 
      height: 520px; 
      border-radius: var(--radius-md); 
      overflow: hidden;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }

    .map-controls { 
      display: flex; 
      gap: 0.75rem; 
      align-items: center; 
      margin-bottom: 1.25rem;
      flex-wrap: wrap;
    }

    .btn {
      background: var(--card-bg-color);
      color: var(--primary-text-color);
      border: 1px solid var(--border-color);
      padding: 0.625rem 1rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .btn:hover { 
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-primary {
      background: var(--accent-color);
      color: #fff;
      border: none;
    }

    .milestone-cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }

    .milestone-card {
      background: var(--card-bg-color);
      border-radius: var(--radius-md);
      padding: 1.25rem;
      border: 1px solid var(--border-color);
      display: flex;
      gap: 1rem;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .milestone-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
    }

    .badge {
      width: 44px; 
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center; 
      justify-content: center;
      font-weight: 700; 
      color: #fff; 
      font-size: 1.1rem;
      flex-shrink: 0;
      background: var(--accent-color);
      box-shadow: var(--shadow-sm);
    }

    .card-body { flex: 1; }
    
    .card-title { 
      font-weight: 700; 
      margin: 0 0 0.25rem 0; 
      color: var(--primary-text-color);
    }

    .daily-itinerary-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.25rem;
    }

    .day-card {
      background: var(--card-bg-color);
      border-radius: var(--radius-md);
      padding: 1.5rem;
      border: 1px solid var(--border-color);
      transition: transform 0.2s ease;
    }

    .day-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    .travel-instructions ol { 
      list-style: none; 
      padding-left: 0;
      counter-reset: leg-counter;
    }

    .travel-leg {
      position: relative;
      padding: 1.25rem 1.25rem 1.25rem 3rem;
      margin-bottom: 1.25rem;
      background: var(--card-bg-color);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      transition: transform 0.2s ease;
    }

    .travel-leg:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
    }

    .stops-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.25rem;
    }

    .stop-card {
      background: var(--card-bg-color);
      border-radius: var(--radius-md);
      padding: 1.5rem;
      border: 1px solid var(--border-color);
      transition: transform 0.2s ease;
    }

    .stop-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .back-link { 
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 2rem;
      padding: 0.75rem 1.25rem;
      background: var(--card-bg-color);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--primary-text-color);
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    /* Note: removed the CSS that merely hid the routing control.
       Instead the routing-control is not created and we draw the route polyline directly,
       so there's no extra control box inserted on the map. */

    @media (max-width: 768px) {
      .details-grid { grid-template-columns: 1fr; }
      .result-header { padding: 1.5rem; }
      .section-card { padding: 1.5rem; }
      .map-full { height: 400px; }
    }
  </style>
{% endblock %}

{% block content %}
  <div class="result-header">
    <h1>Your Trip to <span>{{ parsed.destination_name or destination }}</span></h1>
    <div class="sub-details">
      <div>Preferences: <span>{{ preferences or 'Not specified' }}</span></div>
      <div>Days: <span>{{ days or 'Not specified' }}</span></div>
      <div>Budget: <span>{{ budget or 'Not specified' }}</span></div>
    </div>
  </div>

  <div class="section-card">
    <h3>Interactive Route</h3>
    <div class="map-controls">
      <button class="btn" id="fitBtn">Fit to Route</button>
      <button class="btn" id="zoomIn">Zoom +</button>
      <button class="btn" id="zoomOut">Zoom −</button>
      <div style="flex:1"></div>
      {% if maps_directions_link %}
        <a class="btn btn-primary" href="{{ maps_directions_link }}" target="_blank" rel="noopener">Open in Google Maps</a>
      {% elif maps_search_link %}
        <a class="btn btn-primary" href="{{ maps_search_link }}" target="_blank" rel="noopener">Open in Google Maps</a>
      {% endif %}
    </div>

    {% if coords_list and coords_list|length >= 2 %}
      <div id="leafletMap" class="map-full"></div>
    {% else %}
      <div class="card-sub">Not enough geographic coordinates were available to render an interactive map.</div>
    {% endif %}
  </div>

  <div class="section-card">
    <h3>Stops Overview</h3>
    <div class="milestone-cards-container">
      {% for node in visit_nodes %}
        {% set idx = loop.index0 %}
        <div class="milestone-card" data-index="{{ idx }}">
          <div class="badge">{{ node.order }}</div>
          <div class="card-body">
            <div class="card-title">{{ node.location_name }}</div>
            <div class="card-sub">{{ node.suggested_time }} • {{ node.estimated_duration }}</div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="section-card">
    <h3>Daily Itinerary</h3>
    {% if itinerary %}
      <div class="daily-itinerary-container">
        {% for day in itinerary %}
          <div class="day-card">
            <div class="day-header">
              <span class="day-number">Day {{ day.day_number }}</span>
              <span class="day-summary">{{ day.summary }}</span>
            </div>
            <ul class="list">
              {% for activity in day.activities %}
                <li>{{ activity }}</li>
              {% endfor %}
            </ul>
            {% if day.approximate_cost %}
              <div class="day-cost">Approx. Cost: {{ day.approximate_cost }}</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="card-sub">No detailed daily itinerary was provided.</p>
    {% endif %}
  </div>

  <div class="section-card">
    <h3>Dining & Stays</h3>
    <div class="details-grid">
      <div>
        <h4>Popular Dinner Picks</h4>
        {% if popular_dinners %}
          <ul class="list">
            {% for d in popular_dinners %}
              <li>
                <strong>{{ d.name or d.title or 'Unknown' }}</strong>
                <div class="card-sub">
                  {% if d.rating %}{{ d.rating }}/5 {% endif %}
                  {% if d.price_level %}({{ d.price_level }}){% endif %}
                  {% if d.reason %}• {{ d.reason }}{% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="card-sub">No specific dinner recommendations provided.</p>
        {% endif %}
      </div>

      <div>
        <h4>Recommended Stays</h4>
        {% if popular_stays %}
          <ul class="list">
            {% for s in popular_stays %}
              <li>
                <strong>{{ s.name or s.title or s.hotel_name or 'Unknown' }}</strong>
                <div class="card-sub">
                  {% if s.rating %}{{ s.rating }}/5 {% endif %}
                  {% if s.price_level %}({{ s.price_level }}){% endif %}
                  {% if s.reason %}• {{ s.reason }}{% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="card-sub">No specific stay recommendations provided.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="section-card travel-instructions">
    <h3>Travel Instructions</h3>
    {% if travel_instructions %}
      <ol style="counter-reset: leg-counter;">
        {% for leg in travel_instructions %}
          <li class="travel-leg">
            <div class="travel-header">
              <div>
                <strong>{{ leg.from or 'Start' }} → {{ leg.to or 'End' }}</strong>
                <div class="card-sub">
                  {% if leg.transport %}via {{ leg.transport }}{% endif %}
                  {% if leg.approx_time %} ({{ leg.approx_time }}){% endif %}
                </div>
              </div>
              {% if leg.map_link %}
                <a href="{{ leg.map_link }}" target="_blank" rel="noopener" class="btn">Directions</a>
              {% endif %}
            </div>
            {% if leg.notes %}<p class="card-sub" style="margin:0.5rem 0 0;">{{ leg.notes }}</p>{% endif %}
          </li>
        {% endfor %}
      </ol>
    {% else %}
      <p class="card-sub">No step-by-step travel instructions were provided.</p>
    {% endif %}
  </div>

  <div class="section-card">
    <h3>Stop Details & Food Picks</h3>
    <div class="stops-grid">
      {% for node in visit_nodes %}
        <div class="stop-card">
          <h4>{{ node.order }}. {{ node.location_name }}</h4>
          {% if node.note %}<p class="card-sub" style="margin-bottom: 1rem;">{{ node.note }}</p>{% endif %}
          <strong>Nearby Food:</strong>
          {% if node.nearby_food_recommendations %}
            <ul class="list" style="margin-top: 0.5rem;">
              {% for f in node.nearby_food_recommendations %}
                <li>
                  <strong>{{ f.name }}</strong>
                  <div class="card-sub">
                    {% if f.rating %}{{ f.rating }}/5 {% endif %}
                    {% if f.price_level %}({{ f.price_level }}){% endif %}
                    {% if f.distance_m %}• {{ f.distance_m }}m away{% endif %}
                    {% if f.reason %}• {{ f.reason }}{% endif %}
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="card-sub">No specific food recommendations for this stop.</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>

  <a href="{{ url_for('index') }}" class="back-link">Plan Another Trip</a>
{% endblock %}

{% block scripts %}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
  <script>
    (function(){
      const coords = {{ coords_list|tojson }};
      const visitNodes = {{ visit_nodes|tojson }};
      let markers = [];
      let map;
      let routeLine = null;
      const router = L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' });

      function buildWaypointsFromCoordsArray(arr) {
        return arr.map(c => L.Routing.waypoint(L.latLng(c[0], c[1])));
      }

      function drawRouteFromCoordsArray(arr) {
        if (!arr || arr.length < 2) return;
        const waypoints = buildWaypointsFromCoordsArray(arr);
        router.route(waypoints, (err, routes) => {
          if (routeLine) {
            try { map.removeLayer(routeLine); } catch(e){ /* ignore */ }
            routeLine = null;
          }
          if (err || !routes || !routes.length) return;
          // L.Routing.line expects a "route" object returned by router
          routeLine = L.Routing.line(routes[0], {
            styles: [{ color: '#0052ff', opacity: 0.85, weight: 5 }],
            extendToWaypoints: false,
            addWaypoints: false
          }).addTo(map);
        });
      }

      if (coords && coords.length >= 2) {
        map = L.map('leafletMap', { zoomControl: true, preferCanvas: true });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

        const waypoints = coords.map(c => L.latLng(c[0], c[1]));

        visitNodes.forEach((n, i) => {
          if (n.latitude == null || n.longitude == null) return;
          const lat = parseFloat(n.latitude), lon = parseFloat(n.longitude);
          const color = ['#d94848','#f59e0b','#10b981','#3b82f6'][i % 4];
          const html = `<div style="background:${color};width:36px;height:36px;border-radius:18px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:1rem;transition:all .2s ease;">${n.order}</div>`;
          const icon = L.divIcon({ html, className: 'custom-map-marker', iconSize: [36,36], iconAnchor: [18,18] });
          const marker = L.marker([lat, lon], { icon, zIndexOffset: 100 }).addTo(map);
          let popupHtml = `<strong>${n.location_name}</strong><br/><small>${n.suggested_time} • ${n.estimated_duration}</small>`;
          marker.bindPopup(popupHtml);
          markers.push(marker);
        });

        // Draw the full route polyline initially (no control box)
        drawRouteFromCoordsArray(coords);

        const group = L.featureGroup(markers.length ? markers : waypoints.map(w => L.marker(w)));
        map.fitBounds(group.getBounds().pad(0.12));

        document.getElementById('fitBtn').addEventListener('click', () => {
          if (routeLine) {
            // fit to route polyline bounds if available
            try {
              map.fitBounds(routeLine.getBounds().pad ? routeLine.getBounds().pad(0.12) : routeLine.getBounds().pad(0.12));
            } catch (e) {
              map.fitBounds(group.getBounds().pad(0.12));
            }
          } else {
            map.fitBounds(group.getBounds().pad(0.12));
          }
        });
        document.getElementById('zoomIn').addEventListener('click', () => map.zoomIn());
        document.getElementById('zoomOut').addEventListener('click', () => map.zoomOut());

        const milestoneCards = document.querySelectorAll('.milestone-card');
        milestoneCards.forEach((card, i) => {
          const marker = markers[i];
          if (!marker) return;

          card.addEventListener('mouseenter', () => {
            marker.setZIndexOffset(1000);
            const el = marker.getElement();
            if (el) el.style.transform = 'scale(1.25)';
          });
          card.addEventListener('mouseleave', () => {
            marker.setZIndexOffset(100);
            const el = marker.getElement();
            if (el) el.style.transform = 'scale(1)';
          });

          card.addEventListener('click', () => {
            const n = visitNodes[i];
            if (!n || n.latitude == null || n.longitude == null) return;

            // Draw route from origin (first coord) to the selected destination only
            const origin = coords[0];
            const dest = [parseFloat(n.latitude), parseFloat(n.longitude)];
            drawRouteFromCoordsArray([origin, dest]);

            // center map on the selected destination and open its popup
            const targetZoom = Math.max(map.getZoom(), 13);
            map.setView([n.latitude, n.longitude], targetZoom, { animate: true, duration: 0.5 });
            marker.openPopup();
          });
        });
      }
    })();
  </script>
{% endblock %}